%YAML 1.1
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/harp-tech/reflex-generator/main/schema/device.json
device: StepperDriver
whoAmI: 1130
firmwareVersion: "0.1"
hardwareTargets: "0.1"
registers:

##################################
# Enable and disable
##################################
  EnableMotors:
    address: 32
    type: U8
    access: Write
    maskType: StepperMotors
    description: Specifies a set of motors to enable in the device.
  DisableMotors:
    address: 33
    type: U8
    access: Write
    maskType: StepperMotors
    description: Specifies a set of motors to disable in the device.
  EnableEncoders:
    address: 34
    type: U8
    access: Write
    maskType: QuadratureEncoders
    description: Specifies a set of port quadrature counters to enable in the device.
  DisableEncoders:
    address: 35
    type: U8
    access: Write
    maskType: QuadratureEncoders
    description: Specifies a set of port quadrature counters to disable in the device.
  EnableInputs:  
    address: 36
    type: U8
    access: Write
    maskType: DigitalInputs
    description: Specifies a set of digital inputs to enable in the device.
  DisableInputs:
    address: 37
    type: U8
    access: Write
    maskType: DigitalInputs
    description: Specifies a set of digital inputs to disable in the device.

##################################
# Configuration
##################################
  OperationModeMotor0: &opmode
    address: 38
    type: U8
    access: Write
    maskType: MotorOperationMode
    description: Configures the operation mode for motor 0.
  OperationModeMotor1:
    <<: *opmode
    address: 39
    description: Configures the operation mode for motor 1.
  OperationModeMotor2:
    <<: *opmode
    address: 40
    description: Configures the operation mode for motor 2.
  OperationModeMotor3:
    <<: *opmode
    address: 41
    description: Configures the operation mode for motor 3.

  MicrostepResolutionMotor0: &microstep_resolution
    address: 42
    type: U8
    access: Write
    maskType: MicrostepResolution
    description: Configures the microstep resolution for motor 0.  
  MicrostepResolutionMotor1:
    <<: *microstep_resolution
    address: 43
    description: Configures the microstep resolution for motor 1.
  MicrostepResolutionMotor2:
    <<: *microstep_resolution
    address: 44
    description: Configures the microstep resolution for motor 2.
  MicrostepResolutionMotor3:
    <<: *microstep_resolution
    address: 45
    description: Configures the microstep resolution for motor 3.

  MaximumCurrentRmsMotor0: &maxcurrent
    address: 46
    minValue: 0.139
    maxValue: 2.1
    defaultValue: 0.2
    type: Float
    access: Write
    description: Configures the maximum RMS current per phase for motor 0.
  MaximumCurrentRmsMotor1:
    <<: *maxcurrent
    address: 47
    description: Configures the maximum RMS current per phase for motor 1.
  MaximumCurrentRmsMotor2:
    <<: *maxcurrent
    address: 48
    description: Configures the maximum RMS current per phase for motor 2.
  MaximumCurrentRmsMotor3:
    <<: *maxcurrent
    address: 49
    description: Configures the maximum RMS current per phase for motor 3.

  NominalStepIntervalMotor0: &nominalinterval
    address: 50
    minValue: 100
    maxValue: 20000
    defaultValue: 250
    type: U16
    access: Write
    description: Configures the time between step motor pulses when running at nominal speed for motor 0.
  NominalStepIntervalMotor1:
    <<: *nominalinterval
    address: 51
    description: Configures the time between step motor pulses when running at nominal speed for motor 1.
  NominalStepIntervalMotor2:
    <<: *nominalinterval
    address: 52
    description: Configures the time between step motor pulses when running at nominal speed for motor 2.
  NominalStepIntervalMotor3:
    <<: *nominalinterval
    address: 53
    description: Configures the time between step motor pulses when running at nominal speed for motor 3.

  MaximumStepIntervalMotor0: &maxinterval
    address: 54
    minValue: 100
    maxValue: 20000
    defaultValue: 2000
    type: U16
    access: Write
    description: Configures the time between step motor pulses used when starting or stopping a movement for motor 0.
  MaximumStepIntervalMotor1:
    <<: *maxinterval
    address: 55
    description: Configures the time between step motor pulses used when starting or stopping a movement for motor 1.
  MaximumStepIntervalMotor2:
    <<: *maxinterval
    address: 56
    description: Configures the time between step motor pulses used when starting or stopping a movement for motor 2.
  MaximumStepIntervalMotor3:
    <<: *maxinterval
    address: 57
    description: Configures the time between step motor pulses used when starting or stopping a movement for motor 3.

  StepAccelerationIntervalMotor0: &accperiod
    address: 58
    minValue: 2
    maxValue: 2000
    defaultValue: 10
    type: U16
    access: Write
    description: Configures the acceleration for motor 0. The time between step pulses is decreased by this value when accelerating and increased when decelerating.
  StepAccelerationIntervalMotor1:
    <<: *accperiod
    address: 59
    description: Configures the acceleration for motor 1. The time between step pulses is decreased by this value when accelerating and increased when decelerating.
  StepAccelerationIntervalMotor2:
    <<: *accperiod
    address: 60
    description: Configures the acceleration for motor 2. The time between step pulses is decreased by this value when accelerating and increased when decelerating.
  StepAccelerationIntervalMotor3:
    <<: *accperiod
    address: 61
    description: Configures the acceleration for motor 3. The time between step pulses is decreased by this value when accelerating and increased when decelerating.

  EncoderMode:
    address: 62
    type: U8
    access: Write
    maskType: EncoderModeConfig
    description: Configures the operation mode of the quadrature encoders.
  EncoderRate:
    address: 63
    type: U8
    access: Write
    maskType: EncoderRateConfig
    description: Configures the reading rate of the encoders' event.
  
  OperationModeInput0: &input_mode
    address: 64
    type: U8
    access: Write
    maskType: InputOperationMode
    description: Configures the operation mode for digital input 0.
  OperationModeInput1:
    <<: *input_mode
    address: 65
    description: Configures the operation mode for digital input 1.
  OperationModeInput2:
    <<: *input_mode
    address: 66
    description: Configures the operation mode for digital input 2.
  OperationModeInput3:
    <<: *input_mode
    address: 67
    description: Configures the operation mode for digital input 3.

  TriggerModeInput0: &trig_mode
    address: 68
    type: U8
    access: Write
    maskType: TriggerMode
    description: Configures the sense mode for digital input 0.
  TriggerModeInput1:
    <<: *trig_mode
    address: 69
    description: Configures the sense mode for digital input 1.
  TriggerModeInput2:
    <<: *trig_mode
    address: 70
    description: Configures the sense mode for digital input 2.
  TriggerModeInput3:
    <<: *trig_mode
    address: 71
    description: Configures the sense mode for digital input 3.

  EmergencyStopMode:
    address: 72
    type: U8
    access: Write
    maskType: TriggerMode
    description: Configures the edge detection mode for the emergency external button.

##################################
# Events
##################################
  MotorStopped:
    address: 73
    type: U8
    access: Event
    maskType: StepperMotors
    description: Contains a bit mask specifying the motor that stopped the movement.
  MotorOvervoltageDetection:
    address: 74
    type: U8
    access: Event
    maskType: StepperMotors
    description: Contains a bit mask specifying the motor where the overvoltage detection and protection mechanism occurred, which can happen when the there's a quick deceleration from a high velocity or when the motor stalls.
  MotorErrorDetection:
    address: 75
    type: U8
    access: Event
    maskType: StepperMotors
    description: Contains a bit mask specifying the motor that triggered the error which can be happen in case of short-circuit or driver temperature above 165 degress celsius.

  Encoders:
    address: 76
    type: S16
    length: 3
    access: Event
    description: Contains the quadrature encoder readings.
    payloadSpec:
      Encoder0:
        offset: 0
        description: The quadrature counter on port ENC 0.
      Encoder1:
        offset: 1
        description: The quadrature counter on port ENC 1.
      Encoder2:
        offset: 2
        description: The quadrature counter on port ENC 2.

  DigitalInputState:
    address: 77
    access: Event
    type: U8
    maskType: DigitalInputs
    description: Reflects the state of the digital input lines.

  EmergencyStop:
    address: 78
    type: U8
    access: Event
    maskType: EmergencyStopState
    description: Contains the state of the external emergency button.

##################################
# Movement control
##################################
  StepsMotor0: &motorsteps
    address: 79
    type: S32
    access: Write
    description: Moves motor 0 by the number of steps written in this register and set the direction according to the value's signal.    
  StepsMotor1:
    <<: *motorsteps
    address: 80
    description: Moves motor 1 by the number of steps written in this register and set the direction according to the value's signal.
  StepsMotor2:
    <<: *motorsteps
    address: 81
    description: Moves motor 2 by the number of steps written in this register and set the direction according to the value's signal.
  StepsMotor3:
    <<: *motorsteps
    address: 82
    description: Moves motor 3 by the number of steps written in this register and set the direction according to the value's signal.
  
  MaximumStepsIntegrationMotor0: &motorsmaxsteps
    address: 83
    type: U32
    access: Write
    description: Specifies the limit of the accumulated steps for the positive movement of motor 0. The device will not let the motor move further than this value.
  MaximumStepsIntegrationMotor1:
    <<: *motorsmaxsteps
    address: 84
    description: Specifies the limit of the accumulated steps for the positive movement of motor 1. The device will not let the motor move further than this value.
  MaximumStepsIntegrationMotor2:
    <<: *motorsmaxsteps
    address: 85
    description: Specifies the limit of the accumulated steps for the positive movement of motor 2. The device will not let the motor move further than this value.
  MaximumStepsIntegrationMotor3:
    <<: *motorsmaxsteps
    address: 86
    description: Specifies the limit of the accumulated steps for the positive movement of motor 3. The device will not let the motor move further than this value.

  MinimumStepsIntegrationMotor0: &motorsminsteps
    address: 87
    type: U32
    access: Write
    description: Specifies the limit of the accumulated steps for the negative movement of motor 0. The device will not let the motor move further than this value.
  MinimumStepsIntegrationMotor1:
    <<: *motorsminsteps
    address: 88
    description: Specifies the limit of the accumulated steps for the negative movement of motor 1. The device will not let the motor move further than this value.
  MinimumStepsIntegrationMotor2:
    <<: *motorsminsteps
    address: 89
    description: Specifies the limit of the accumulated steps for the negative movement of motor 2. The device will not let the motor move further than this value.
  MinimumStepsIntegrationMotor3:
    <<: *motorsminsteps
    address: 90
    description: Specifies the limit of the accumulated steps for the negative movement of motor 3. The device will not let the motor move further than this value.
  
  ImmediateStepsMotor0: &immediatesteps
    address: 91
    type: S32
    access: Write
    description: Starts the movement of motor 0 with the step interval defined by this register. The sign of the value specifies the direction.
  ImmediateStepsMotor1:
    <<: *immediatesteps
    address: 92
    description: Starts the movement of motor 1 with the step interval defined by this register. The sign of the value specifies the direction.
  ImmediateStepsMotor2:
    <<: *immediatesteps
    address: 93
    description: Starts the movement of motor 2 with the step interval defined by this register. The sign of the value specifies the direction.
  ImmediateStepsMotor3:
    <<: *immediatesteps
    address: 94
    description: Starts the movement of motor 3 with the step interval defined by this register. The sign of the value specifies the direction.

##################################
# Actions
##################################
  StopMotorSuddenly:
    address: 95
    type: U8
    access: Write
    maskType: StepperMotors
    description: Stops the motors immediately.
  StopMotorSmoothly:
    address: 96
    type: U8
    access: Write
    maskType: StepperMotors
    description: Decelerate the motors until they stop according to configured intervals.
  ResetMotor:
    address: 97
    type: U8
    access: Write
    maskType: StepperMotors
    description: Disables the current error and enables the driver.
  
  ResetEncoder:
    address: 98
    type: U8
    access: Write
    maskType: QuadratureEncoders
    description: Resets the encoder.
  
##################################
# Reserved
##################################
  Reserved0: &reserved
    address: 99
    type: U8
    access: Write
    visibility: private
    description: Contains the CFG configuration pins of the TMC2210 driver that controls motor 0.
  Reserved1:
    <<: *reserved
    address: 100
    description: Contains the CFG configuration pins of the TMC2210 driver that controls motor 1.
  Reserved2:
    <<: *reserved
    address: 101
    description: Contains the CFG configuration pins of the TMC2210 driver that controls motor 2.
  Reserved3:
    <<: *reserved
    address: 102
    description: Contains the CFG configuration pins of the TMC2210 driver that controls motor 3.

  Reserved4:
    <<: *reserved
    address: 103
    visibility: private
    description: Contains the raw data of the digital potentiometer that controls current limit of motor 0.
  Reserved5:
    <<: *reserved
    address: 104
    visibility: private
    description: Contains the raw data of the digital potentiometer that controls current limit of motor 1.
  Reserved6:
    <<: *reserved
    address: 105
    visibility: private
    description: Contains the raw data of the digital potentiometer that controls current limit of motor 2.
  Reserved7:
    <<: *reserved
    address: 106
    visibility: private
    description: Contains the raw data of the digital potentiometer that controls current limit of motor 3.

##################################
# Bit masks
##################################
bitMasks:
  StepperMotors:
    description: Specifies the index of each motor.
    bits:
      Motor0: 0x01
      Motor1: 0x02
      Motor2: 0x04
      Motor3: 0x08
  QuadratureEncoders:
    description: Specifies the index of each motor.
    bits:
      Encoder0: 0x01
      Encoder1: 0x02
      Encoder2: 0x04
  DigitalInputs:
    description: Specifies the digital input lines.
    bits:
      Input0: 0x1
      Input1: 0x2
      Input2: 0x4
      Input3: 0x8

##################################
# Group masks
##################################
groupMasks:
  EncoderModeConfig:
    description: Specifies the type of reading made from the quadrature encoders.
    values:
      Position: 0
      Displacement: 1
  EncoderRateConfig:
    description: Specifies the rate of the events from the quadrature encoders.
    values:
      Rate100Hz: 0
      Rate200Hz: 1
      Rate250Hz: 2
      Rate500Hz: 3
  MotorOperationMode:
    description: Specifies the motor operation mode.
    values:
      QuietMode: 0
      DynamicMovements: 1
  MicrostepResolution:
    description: Specifies the microstep resolution for each step pulse.
    values:
      Microstep8: 0
      Microstep16: 1
      Microstep32: 2
      Microstep64: 3
  InputOperationMode:
    description: Specifies the inputs operation mode.
    values:
      EventOnly: 0
      EventAndStopMotor0: 1
      EventAndStopMotor1: 2
      EventAndStopMotor2: 3
      EventAndStopMotor3: 4
  TriggerMode:
    description: Specifies the input trigger mode.
    values:
      RisingEdge: 0
      FallingEdge: 1
  EmergencyStopState:
    description: Specifies the state of the external emergency button.
    values:
      NoEmergency: 0
      EmergencyDetected: 1